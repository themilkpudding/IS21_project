# Описание API
Здесь описано всё API, используемое в приложении, с описанием структур данных


**Содержание**
1. Общее
    * 1.1. Адрес сервера
    * 1.2. Используемый протокол
2. Структуры данных
    * 2.1. Общий формат ответа
    * 2.2. Пользователь
    * 2.3. Сообщение
    * 2.4. Комната (лобби)
3. Список запросов
    * 3.1. Список ошибок
4. Подробно
    * 4.1. login
    * 4.2. logout
    * 4.3. registration
    * 4.4. math
    * 4.5. createRoom
    * 4.6. joinToRoom
    * 4.7. leaveRoom
    * 4.8. dropFromRoom
    * 4.9. deleteUser
    * 4.10. startGame
    * 4.11. getRooms
    * 4.12. getUserInfo
    * 4.13. getClasses
    * 4.14. getUserOwnedClasses
    * 4.15. buyClass
    * 4.16. selectClass
    * 4.17. buyItem
    * 4.18. buyConsumables



## 1. Общее
### 1.1. Адрес сервера
`http://knightwars.local/api`
`http://knightwars:81/api`

### 1.2. Используемый протокол
API полностью реализовано на http(s). 

Формат возвращаемых значений `JSON`.

Все методы, если это особо не оговорено, имеют тип `GET`.


## 2. Структуры данных
### 2.1. Общий формат ответа
T — какие-то данные. В случае успешного ответа возвращается result = 'ok' и поле data с данными.

В случае ошибки возвращается result = 'error' и поле error с кодом и текстом ошибки
```
Answer<T>: {
    result: 'ok' | 'error';
    data?: T;
    error?: {
        code: number;
        text: string;
    };
}
```

### 2.2. Пользователь
```
User: {
    id: number;
    nickname: string;
    token: string;
}

UserInfo: {
    id: number;
    login: string;
    nickname: string;
    money: number;
}
```

### 2.3. Математика
```
MathResult: number[];
```

### 2.4. Комната (лобби)
```
Room: {
    id: number;
    status: 'open' | 'closed' | 'started';
    players_count: number;
}

RoomsResponse: {
    status: 'unchanged' | 'updated';
    hash?: string;
    rooms?: Room[];
}
```

## 3. Список запросов
| Название | О чем |
| - | - |
| login | Авторизация пользователя |
| logout | Логаут пользователя |
| registration | Регистрация пользователя |
| math | Решение уравнения (1–4 степени)т |
| createRoom | Создание комнаты |
| joinToRoom | Присоединение к комнате |
| leaveRoom | Выход из комнаты |
| dropFromRoom | Исключение участника из комнаты |
| deleteUser | Удаление пользователя |
| startGame | Начало игры в комнате |
| getRooms | Получение списка комнат |
| getUserInfo | Получение информации о пользователе |
| getClasses | Получение списка всех доступных классов |
| getUserOwnedClasses | Получение списка купленных пользователем классов |
| buyClass | Покупка класса пользователем |
| selectClass | Выбор активного класса пользователем |
| buyItem | Покупка предмета (оружие/броня) |
| buyConsumables | Покупка расходников (стрелы/зелья) |



### 3.1. Список ошибок
* `101` - параметр method не передан
* `102` - метод не найден
* `242` - не переданы все необходимые параметры
* `404` - Not found
* `705` - пользователь не найден
* `706` - персонаж не найден
* `1001` - логин уже существует
* `1002` - неверный логин или пароль
* `1003` - ошибка выхода из системы
* `1004` - ошибка регистрации пользователя
* `1005` - пользователь не существует
* `1006` - пользователь с этим адресом электронной почты уже зарегистрирован
* `2001` - ошибка создания комнаты
* `2002` - ошибка добавления пользователя в комнату
* `2003` - комната не найдена
* `2004` - пользователь уже в комнате
* `2005` - пользователь уже является владельцем этой комнаты
* `2006` - пользователь уже играет
* `2007` - комната недоступна
* `2008` - пользователь отсутствует в комнате
* `2009` - владелец не может сам себя выгнать
* `2010` - только владелец может выгнать участников комнаты
* `2011` - пользователь, которого нужно выгнать, не найден в комнате
* `2012` - ошибка удаления пользователя
* `2013` - недостаточно игроков для начала игры (нужно 3 игрока)
* `2014` - вы не можете запустить комнату: вы либо не являетесь её владельцем, либо не находитесь в комнате
* `2015` - комната не найдена или не открыта
* `2016` - данные о комнатах не изменены
* `3001` - пользователь не купил ни одного класса
* `3002` - класс не найден
* `3003` - пользователь не найден
* `3004` - недостаточно средств для покупки класса
* `3005` - ошибка при покупке класса
* `3006` - класс не куплен
* `3007` - класс уже куплен
* `4001` - предмет не найден
* `4002` - недостаточно денег для покупки
* `4003` - предмет уже куплен
* `4004` - ошибка покупки предмета
* `4005` - неверный тип расходника
* `4006` - достигнут лимит стрел (50)
* `4007` - достигнут лимит зелий (3)
* `4008` - ошибка покупки расходников
* `8001` - не передан ни один коэффициент
* `8002` - дискриминант < 0 (нет действительных корней)
* `8003` - нет действительных корней
* `9000` - неизвестная ошибка


## 4. Подробно
### 4.1. login
Авторизация пользователя в системе

**Параметры**
```
{
    "login": "string", - логин пользователя 
    "password": "string" - пароль пользователя
}

```
**Успешный ответ**
```
    Answer<User>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `1002` - неверный пароль
* `1005` - пользователь не существует


### 4.2. logout
Вылогин пользователя из системы

**Параметры**
```
{
    token: string
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден | не авторизован
* `1003` - ошибка выхода из системы


### 4.3. registration
Зарегистрировать нового ползователя

**Параметры**
```
{
    "login": "string", - логин пользователя 
    "password": "string" - пароль пользователя
    "nickname": "string", - имя пользователя
    "email": "string" - почта пользователя 
}
```
**Успешный ответ**
```
    Answer<User>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `1001` - такой логин уже существует
* `1004` - ошибка при регистрации пользователя


### 4.4. math
Решение уравнений 1–4 степени

**Параметры**
```
{
    "a": number, - коэффициент при x^4
    "b": number, - коэффициент при x^3
    "c": number, - коэффициент при x^2
    "d": number, - коэффициент при x
    "e": number  - свободный член
}
```
**Успешный ответ**
```
    Answer<MathResult>
```
**Ошибки**
* `8001` - не передан ни один коэффициент
* `8002` - дискриминант < 0 (нет действительных корней)
* `8003` - нет действительных корней


### 4.5. createRoom
Создание новой комнаты

**Параметры**
```
{
    token: string - токен пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `2005` - пользователь уже является владельцем комнаты
* `2006` - пользователь уже играет


### 4.6. joinToRoom
Присоединение к существующей комнате

**Параметры**
```
{
    token: string, - токен пользователя
    roomId: number - ID комнаты
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2003` - комната не найдена
* `2005` - пользователь уже является владельцем комнаты
* `2006` - пользователь уже играет
* `2007` - комната недоступна


### 4.7. leaveRoom
Выход из комнаты

**Параметры**
```
{
    token: string, - токен пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `2008` - пользователь отсутствует в комнате


### 4.8. dropFromRoom
Исключение участника из комнаты владельцем

**Параметры**
```
{
    token: string, - токен владельца комнаты
    targetToken: string - токен исключаемого пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `2009` - владелец не может сам себя выгнать
* `2010` - только владелец может выгнать участников комнаты
* `2011` - пользователь, которого нужно выгнать, не найден в комнате


### 4.9. deleteUser
Удаление пользователя из системы

**Параметры**
```
{
    token: string - токен пользователя
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `2012` - ошибка удаления пользователя


### 4.10. startGame
Старт игры в комнате (инициатор - только владелец)

**Параметры**
```
{
    token: string - токен владельца комнаты
}
```
**Успешный ответ**
```
    Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `2013` - недостаточно игроков для начала игры (нужно 3 игрока)
* `2014` - вы не можете запустить комнату: вы либо не являетесь её владельцем, либо не находитесь в комнате
* `2015` - комната не найдена или не открыта


### 4.11. getRooms
Получение списка доступных комнат

**Параметры**
```
{
    token: string, - токен пользователя
    room_hash: string - текущий хэш комнат 
}
```
**Успешный ответ**
```
    Answer<RoomsResponse>
```

**Возможные ответы:**
```
{
    status: 'unchanged' - данные не изменились
}
```

```
{
    status: 'updated',
    hash: 'новый_хэш',
    rooms: [
        {
        id: number,
        status: 'open',
        players_count: number
        }
    ] - новые данные
}
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден

### 4.12. getUserInfo
Получение информации о пользователе

**Параметры**
```
{
    "token": "string" - токен пользователя
}
```
**Успешный ответ**
```
   Answer<UserInfo>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден

### 4.13. getClasses
Получение списка всех доступных классов

**Параметры**
```
{}
```
**Успешный ответ**
```
   Answer<Class[]>
```
**Ошибки**
-

### 4.14. getUserOwnedClasses
Получение списка купленных пользователем классов

**Параметры**
```
{
    "token": "string" - токен пользователя
}
```
**Успешный ответ**
```
   Answer<ClassOwned[]>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `3001` - Классы не найдены
### 4.15. buyClass
Покупка класса пользователем

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "classId": number - ID класса для покупки
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `3002` - класс не найден
* `3003` - пользователь не найден
* `3004` - недостаточно средств
* `3005` - ошибка при покупке
* `3007` - класс уже куплен

### 4.16. selectClass
Выбор активного класса пользователем

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "classId": number - ID класса для покупки
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не передан токен
* `705` - пользователь не найден
* `3006` - класс не куплен

### 4.17. buyItem
Покупка предмета (оружие/броня)

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "itemId": number - ID предмета для покупки
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `706` - персонаж не найден
* `4001` - предмет не найден
* `4002` - недостаточно денег для покупки
* `4003` - предмет уже куплен
* `4004` - ошибка покупки предмета

### 4.18. buyConsumables
Покупка расходников (стрелы/зелья)

**Параметры**
```
{
    "token": "string" - токен пользователя,
    "consumType": "string" - тип расходника ('arrows'/'potions')
}
```
**Успешный ответ**
```
  Answer<true>
```
**Ошибки**
* `242` - не переданы все необходимые параметры
* `705` - пользователь не найден
* `706` - персонаж не найден
* `4002` - недостаточно денег для покупки
* `4005` - неверный тип расходника
* `4006` - достигнут лимит стрел (50)
* `4007` - достигнут лимит зелий (3)
* `4008` - ошибка покупки расходников



